<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMAC - Gestão de Qualidade</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Html2Pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f5f5f4; color: #1c1917; }
        
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }
        
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); }
        
        .print-only { display: none; }

        /* Toast Animations */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            
            body { 
                background-color: white; 
                color: black; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                font-size: 9pt; 
            }
            
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            .print-container { 
                width: 100% !important; 
                max-width: none !important; 
                padding: 0 !important; 
                margin: 0 !important; 
                border: none !important;
                box-shadow: none !important;
            }
            
            .print-border { border: 1px solid #ccc !important; padding: 10px !important; border-radius: 6px; }
            
            /* -- LAYOUT DE 2 COLUNAS PARA ECONOMIA DE PAPEL -- */
            .print-grid-2-cols { 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 15px; 
                page-break-inside: avoid;
            }
            
            .print-nc-item {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                padding: 8px;
                margin-bottom: 0; /* Grid controla o gap */
                background-color: #fff;
            }

            /* -- CABEÇALHO CORRIGIDO -- */
            .print-header-grid {
                display: grid;
                grid-template-columns: 2fr 1fr 1fr 1fr; /* Setor tem espaço duplo */
                gap: 10px;
                background-color: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                padding: 10px;
                margin-bottom: 15px;
                align-items: center;
            }
            
            .no-break { break-inside: avoid; page-break-inside: avoid; }
            .print-img-small { height: 35px !important; width: auto !important; }

            /* -- FOTOS GRANDES (8.5cm x 6.5cm) -- */
            .print-img-evidence { 
                width: 8.5cm !important; 
                height: 6.5cm !important; 
                object-fit: contain; 
                border: 1px solid #eee; 
                display: block; 
                background: #fff; 
                margin-top: 5px;
            }
            
            /* Gráficos lado a lado no retrato */
            .chart-container-print { 
                display: flex; 
                justify-content: center;
                gap: 20px; 
                page-break-inside: avoid; 
                margin-bottom: 15px;
            }
            .chart-item-print { 
                width: 45%; 
                border: 1px solid #eee; 
                padding: 5px; 
                border-radius: 6px; 
                background: #fff;
                display: flex;
                flex-direction: column;
                align-items: center;
                page-break-inside: avoid; /* Evita quebrar gráfico ao meio */
            }
            /* Forçar tamanho do SVG na impressão */
            .print-chart-svg { 
                width: 80px !important; 
                height: 80px !important; 
                min-width: 80px !important; 
                display: block !important; 
            }
            
            /* Ajustes de Tipografia */
            h1 { font-size: 14pt !important; margin: 0 !important; }
            h2 { font-size: 11pt !important; margin-bottom: 8px !important; border-bottom: 1px solid #ccc; padding-bottom: 2px; page-break-after: avoid; }
            h3 { font-size: 10pt !important; margin: 0 !important; }
            p { margin: 0 !important; }
            
            /* Ocultar scrollbars na impressão */
            ::-webkit-scrollbar { display: none; }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-stone-100 text-stone-950 font-sans antialiased">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- CONFIGURAÇÃO INDEXEDDB ---
        const DB_NAME = 'IMAC_QUALITY_DB';
        const DB_VERSION = 2; 
        
        const IDB = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('config')) db.createObjectStore('config');
                        if (!db.objectStoreNames.contains('inspections')) db.createObjectStore('inspections', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('resolutions')) db.createObjectStore('resolutions', { keyPath: 'id' }); 
                    };
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            getConfig: async (key) => {
                const db = await IDB.open();
                return new Promise((resolve) => {
                    const tx = db.transaction('config', 'readonly');
                    const req = tx.objectStore('config').get(key);
                    req.onsuccess = () => resolve(req.result);
                });
            },
            setConfig: async (key, val) => {
                const db = await IDB.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('config', 'readwrite');
                    tx.objectStore('config').put(val, key);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            getAllInspections: async () => {
                const db = await IDB.open();
                return new Promise((resolve) => {
                    const tx = db.transaction('inspections', 'readonly');
                    const req = tx.objectStore('inspections').getAll();
                    req.onsuccess = () => resolve(req.result || []);
                });
            },
            saveInspection: async (inspection) => {
                const db = await IDB.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('inspections', 'readwrite');
                    tx.objectStore('inspections').put(inspection);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            deleteInspection: async (id) => {
                const db = await IDB.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('inspections', 'readwrite');
                    tx.objectStore('inspections').delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            getAllResolutions: async () => {
                const db = await IDB.open();
                return new Promise((resolve) => {
                    const tx = db.transaction('resolutions', 'readonly');
                    const req = tx.objectStore('resolutions').getAll();
                    req.onsuccess = () => resolve(req.result || []);
                });
            },
            saveResolution: async (res) => {
                const db = await IDB.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resolutions', 'readwrite');
                    tx.objectStore('resolutions').put(res);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }
        };

        // --- DADOS PADRÃO ---
        const STATIC_DB_PERGUNTAS = [
            { id: "def_1", setor: "ESTOQUE", grupo: "MANIPULADOR", pergunta: "MANIPULADOR - Manipuladores com fardamento completo e conservado?", critical: false, weight: 1 },
            { id: "def_2", setor: "ESTOQUE", grupo: "MANIPULADOR", pergunta: "MANIPULADOR - Higiene pessoal adequada (unhas curtas, barba feita)?", critical: false, weight: 1 },
            { id: "def_3", setor: "ESTOQUE", grupo: "GERAL", pergunta: "SETOR GERAL - Setor limpo (piso/parede/teto/portas)?", critical: true, weight: 3 },
            { id: "def_4", setor: "ESTOQUE", grupo: "GERAL", pergunta: "SETOR GERAL - Produtos organizados e identificados (PVPS)?", critical: true, weight: 3 },
            { id: "def_5", setor: "ESTOQUE", grupo: "CÂMARA", pergunta: "CÂMARA - Temperaturas adequadas e registradas?", critical: true, weight: 3 },
            { id: "def_6", setor: "PRE_PESAGEM", grupo: "MANIPULADOR", pergunta: "MANIPULADOR - Uso correto de EPIs?", critical: false, weight: 1 },
            { id: "def_7", setor: "PRE_PESAGEM", grupo: "GERAL", pergunta: "SETOR GERAL - Bancadas limpas e organizadas?", critical: false, weight: 1 },
            { id: "def_8", setor: "PRE_PESAGEM", grupo: "CLIMA", pergunta: "CLIMATIZAÇÃO - Temperatura entre 17º e 20ºC?", critical: false, weight: 1 },
        ];

        // --- ÍCONES SVG ---
        const Icons = {
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            Gear: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Pen: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Excel: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="16" y1="8" x2="8" y2="16"/><line x1="8" y1="8" x2="16" y2="16"/></svg>,
            Star: ({ filled }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            Archive: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
        };

        // --- HELPER FUNCTIONS ---
        const getLocalDateString = (dateObj) => {
            if (!dateObj) return new Date().toISOString().slice(0, 10);
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const createSafeDate = (dateStr) => {
            if (!dateStr) return new Date();
            if (dateStr.length === 10) return new Date(dateStr + 'T12:00:00');
            return new Date(dateStr);
        };
        
        const formatDateDisplay = (dateStr) => {
            if (!dateStr) return "-";
            const date = createSafeDate(dateStr);
            return date.toLocaleDateString('pt-BR');
        };

        const getWeekID = (dateStr, offset = 0) => {
            try {
                let now;
                if (!dateStr) {
                    now = new Date();
                } else {
                    if (dateStr.length === 10) { 
                        now = new Date(dateStr + 'T12:00:00');
                    } else {
                        now = new Date(dateStr);
                    }
                }
                now.setDate(now.getDate() + (offset * 7));
                const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const year = d.getUTCFullYear();
                const weekNo = Math.ceil(( ( (d - new Date(Date.UTC(year,0,1))) / 86400000) + 1)/7);
                return `${year}-W${weekNo}`;
            } catch (e) { return "INVALID-DATE"; }
        };

        const getWeekRangeFromDate = (dateStr) => {
             const curr = createSafeDate(dateStr);
             const day = curr.getDay(); 
             const diff = curr.getDate() - day + (day === 0 ? -6 : 1); 
             
             const first = new Date(curr);
             first.setDate(diff);
             
             const last = new Date(curr);
             last.setDate(diff + 6);
             
             return `${first.toLocaleDateString('pt-BR')} até ${last.toLocaleDateString('pt-BR')}`;
        }

        const ToastContext = React.createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };
            return (
                <ToastContext.Provider value={addToast}>
                    {children}
                    <div className="fixed top-4 right-4 z-50 space-y-2">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast-enter p-4 rounded-lg shadow-xl text-white font-bold flex items-center gap-2 ${t.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
                                {t.type === 'success' ? <Icons.Check /> : <Icons.Alert />}
                                {t.msg}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => React.useContext(ToastContext);

        const Lightbox = ({ src, onClose }) => {
            if (!src) return null;
            return (
                <div className="fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center p-4" onClick={onClose}>
                    <img src={src} className="max-w-full max-h-full rounded shadow-2xl" />
                    <button className="absolute top-4 right-4 text-white p-2 bg-white/20 rounded-full hover:bg-white/40"><Icons.Trash /></button>
                </div>
            );
        };

        const PieChart = ({ data, isReport }) => {
            const total = data.reduce((acc, curr) => acc + curr.value, 0);
            if (total === 0) return <div className={`text-center text-xs h-32 flex items-center justify-center ${isReport ? 'text-black' : 'text-stone-600'}`}>Sem dados</div>;
            let cumulativePercent = 0;
            const getCoordinatesForPercent = (percent) => {
                // Ajuste matemático para PDF (inicia no topo)
                const x = Math.cos(2 * Math.PI * percent - Math.PI / 2);
                const y = Math.sin(2 * Math.PI * percent - Math.PI / 2);
                return [x, y];
            }
            return (
                <div className="flex flex-row items-center justify-center gap-4">
                     {/* Estilo inline para forçar tamanho no PDF */}
                    <div style={{ width: isReport ? '100px' : '128px', height: isReport ? '100px' : '128px' }} className="shrink-0 relative print-chart-svg">
                        <svg viewBox="-1 -1 2 2" style={{ width: '100%', height: '100%', overflow: 'visible' }}>
                            {data.map((slice, i) => {
                                if (slice.value === 0) return null;
                                const startPercent = cumulativePercent;
                                const slicePercent = slice.value / total;
                                cumulativePercent += slicePercent;
                                const endPercent = cumulativePercent;
                                const [startX, startY] = getCoordinatesForPercent(startPercent);
                                const [endX, endY] = getCoordinatesForPercent(endPercent);
                                const largeArcFlag = slicePercent > 0.5 ? 1 : 0;
                                const pathData = `M 0 0 L ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} L 0 0`;
                                return <path key={i} d={pathData} fill={slice.color} stroke={isReport ? "#ffffff" : "#f5f5f4"} strokeWidth="0.02" />;
                            })}
                        </svg>
                    </div>
                    <div className="flex-1 space-y-1">
                        {data.map((slice, i) => (
                            slice.value > 0 && (
                                <div key={i} className="flex items-center text-xs">
                                    <div className="w-2 h-2 rounded-full mr-2" style={{backgroundColor: slice.color}}></div>
                                    <span className={`flex-1 ${isReport ? 'text-black' : 'text-stone-600'}`}>{slice.label}</span>
                                    <span className={`font-bold ml-1 ${isReport ? 'text-black' : 'text-stone-800'}`}>{Math.round((slice.value / total) * 100)}% ({slice.value})</span>
                                </div>
                            )
                        ))}
                    </div>
                </div>
            );
        };

        const getStarCount = (s) => {
            if (s >= 96) return 5;
            if (s >= 85) return 4;
            if (s >= 70) return 3;
            if (s >= 50) return 2;
            return 1;
        };

        const StarRating = ({ score }) => {
            const count = getStarCount(score);
            return (
                <div className="flex gap-0.5 text-yellow-500" title={`${count} Estrelas`}>
                    {[...Array(5)].map((_, i) => (
                        <Icons.Star key={i} filled={i < count} />
                    ))}
                </div>
            );
        };

        const SignaturePad = ({ onSave, initialData, onCancel }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                if(!canvasRef.current) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#000"; 
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                if (initialData) {
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, 0, 0);
                    img.src = initialData;
                }
            }, []);

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = () => { setIsDrawing(false); };
            const handleClear = () => { const canvas = canvasRef.current; const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); };
            const handleConfirm = () => { onSave(canvasRef.current.toDataURL()); };

            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 modal-overlay">
                    <div className="bg-stone-100 border border-stone-300 rounded-xl shadow-2xl w-full max-w-md p-6 animate-fade-in relative">
                        <button type="button" onClick={onCancel} className="absolute top-2 right-2 text-stone-400 hover:text-stone-600 font-bold p-2 z-10">✕</button>
                        <h3 className="text-lg font-bold text-stone-800 mb-4 flex items-center gap-2"><Icons.Pen /> Assinatura do Responsável</h3>
                        <div className="bg-white rounded-lg mb-4 h-48 border border-stone-400 relative overflow-hidden touch-none">
                             <canvas 
                                ref={canvasRef} 
                                className="w-full h-full block cursor-crosshair"
                                onMouseDown={startDrawing} 
                                onMouseMove={draw} 
                                onMouseUp={stopDrawing} 
                                onMouseLeave={stopDrawing} 
                                onTouchStart={startDrawing} 
                                onTouchMove={draw} 
                                onTouchEnd={stopDrawing} 
                            />
                            <div className="absolute bottom-2 right-2 text-xs text-gray-400 pointer-events-none select-none">Assine neste quadro</div>
                        </div>
                        <div className="flex gap-2">
                             <button type="button" onClick={onCancel} className="flex-1 py-3 border border-stone-300 rounded-lg text-stone-600 font-bold hover:bg-stone-200 transition-colors">Cancelar</button>
                             <button type="button" onClick={handleClear} className="px-4 py-3 border border-stone-300 rounded-lg text-stone-600 font-bold hover:text-red-500 hover:bg-stone-200 transition-colors" title="Limpar"><Icons.Trash /></button>
                             <button type="button" onClick={handleConfirm} className="flex-1 py-3 bg-yellow-500 text-stone-900 rounded-lg font-bold hover:bg-yellow-400 shadow-lg shadow-yellow-500/20 transition-colors">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        function AppContent() {
            const toast = useToast();
            const [view, setView] = useState('loading');
            const [selectedSetor, setSelectedSetor] = useState('');
            const [responsavel, setResponsavel] = useState('');
            const [questions, setQuestions] = useState([]);
            const [inspections, setInspections] = useState([]);
            const [resolutions, setResolutions] = useState([]); 
            const [logo, setLogo] = useState(null);
            const [lastBackup, setLastBackup] = useState(null);
            const [weekOffset, setWeekOffset] = useState(0); 
            const [lightboxImg, setLightboxImg] = useState(null);
            const [isDraftLoaded, setIsDraftLoaded] = useState(false);
            
            const today = new Date();
            const localISODate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const [inspectionDate, setInspectionDate] = useState(localISODate);
            const [analyticsSelectedDate, setAnalyticsSelectedDate] = useState(localISODate);

            const [historyStartDate, setHistoryStartDate] = useState(localISODate);
            const [historyEndDate, setHistoryEndDate] = useState(localISODate);

            const [followupTab, setFollowupTab] = useState('pending');
            const [followupHistorySearch, setFollowupHistorySearch] = useState('');
            const [followupHistoryDate, setFollowupHistoryDate] = useState('');

            const [inspectionSearch, setInspectionSearch] = useState('');
            const [answers, setAnswers] = useState({});
            const [obs, setObs] = useState({});
            const [evidences, setEvidences] = useState({}); 
            const [signature, setSignature] = useState(null);
            const [isSigning, setIsSigning] = useState(false);
            const [editingInspectionId, setEditingInspectionId] = useState(null);
            const [previousNCs, setPreviousNCs] = useState({});

            const [reportInspection, setReportInspection] = useState(null);
            const [actionPlan, setActionPlan] = useState('');

            const [settingsTab, setSettingsTab] = useState('questions');
            const [analyticsTab, setAnalyticsTab] = useState('weekly'); 
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [editingQ, setEditingQ] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [adminFilterSetor, setAdminFilterSetor] = useState('TODOS');
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const q = await IDB.getConfig('questions');
                        const l = await IDB.getConfig('logo');
                        const b = await IDB.getConfig('lastBackup');
                        const wo = await IDB.getConfig('weekOffset');
                        const insps = await IDB.getAllInspections();
                        const res = await IDB.getAllResolutions(); 
                        const draft = await IDB.getConfig('current_draft'); 

                        if (!q || q.length === 0) {
                            const lsData = localStorage.getItem('imac_offline_data');
                            if (lsData) {
                                const parsed = JSON.parse(lsData);
                                await IDB.setConfig('questions', parsed.questions || STATIC_DB_PERGUNTAS);
                                await IDB.setConfig('logo', parsed.logo);
                                await IDB.setConfig('lastBackup', parsed.lastBackup);
                                if (parsed.inspections) {
                                    for (let i of parsed.inspections) await IDB.saveInspection(i);
                                }
                                localStorage.removeItem('imac_offline_data');
                                window.location.reload();
                                return;
                            }
                        }

                        setQuestions(q || STATIC_DB_PERGUNTAS);
                        setLogo(l);
                        setLastBackup(b);
                        setWeekOffset(wo || 0);
                        setInspections(insps || []);
                        setResolutions(res || []);

                        if (draft && draft.selectedSetor) {
                            setSelectedSetor(draft.selectedSetor);
                            setResponsavel(draft.responsavel);
                            setInspectionDate(draft.inspectionDate);
                            setAnswers(draft.answers || {});
                            setObs(draft.obs || {});
                            setEvidences(draft.evidencias || {});
                            setSignature(draft.signature);
                            setEditingInspectionId(draft.editingInspectionId);
                            setPreviousNCs(draft.previousNCs || {});
                            setView('inspection');
                            setIsDraftLoaded(true); 
                            toast("Inspeção restaurada automaticamente.", 'success');
                        } else {
                            setView('dashboard');
                            setIsDraftLoaded(true); 
                        }

                    } catch (e) {
                        console.error("Erro ao carregar DB", e);
                        toast("Erro crítico ao carregar banco de dados.", 'error');
                        setIsDraftLoaded(true); 
                    }
                };
                loadData();
            }, []);

            useEffect(() => {
                if (!isDraftLoaded || view !== 'inspection' || !selectedSetor) return;

                const timer = setTimeout(async () => {
                    const draft = {
                        selectedSetor,
                        responsavel,
                        inspectionDate,
                        answers,
                        obs,
                        evidences,
                        signature,
                        editingInspectionId,
                        previousNCs
                    };
                    await IDB.setConfig('current_draft', draft);
                }, 1000); 

                return () => clearTimeout(timer);
            }, [isDraftLoaded, view, selectedSetor, responsavel, inspectionDate, answers, obs, evidences, signature, editingInspectionId, previousNCs]);


            const currentWeekId = getWeekID(localISODate, weekOffset);
            const weekId = getWeekID(inspectionDate); 
            
            const allSetors = useMemo(() => {
                const s = new Set(questions.map(p => p.setor).filter(x => x !== 'TODOS'));
                return Array.from(s).sort();
            }, [questions]);

            const inspectionsThisWeek = useMemo(() => {
                return inspections.filter(i => i.weekId === currentWeekId);
            }, [inspections, currentWeekId]);

            const setoresConcluidos = useMemo(() => new Set(inspectionsThisWeek.map(i => i.setor)), [inspectionsThisWeek]);

            const progress = useMemo(() => {
                const total = allSetors.length;
                const done = setoresConcluidos.size;
                const pct = total === 0 ? 0 : Math.round((done / total) * 100);
                return { total, done, pct };
            }, [allSetors, setoresConcluidos]);

            const currentQuestions = useMemo(() => {
                if (!selectedSetor) return [];
                return questions.filter(p => p.setor === selectedSetor || p.setor === 'TODOS');
            }, [selectedSetor, questions]);

            const scores = useMemo(() => {
                if (currentQuestions.length === 0) return { real: 0, bonus: 0 };
                
                let totalReal = 0, conformesReal = 0;
                let totalBonus = 0, conformesBonus = 0;

                currentQuestions.forEach(q => {
                    const resp = answers[q.id];
                    if (resp && resp !== 'NA') {
                        const weight = q.weight || 1;
                        totalReal += weight;
                        if (resp === 'C') conformesReal += weight;
                        if (q.grupo !== 'ESTRUTURAL') {
                            totalBonus += weight;
                            if (resp === 'C') conformesBonus += weight;
                        }
                    }
                });

                return {
                    real: totalReal === 0 ? 0 : Math.round((conformesReal / totalReal) * 100),
                    bonus: totalBonus === 0 ? 0 : Math.round((conformesBonus / totalBonus) * 100)
                };
            }, [answers, currentQuestions]);

            // --- GESTÃO DE PENDÊNCIAS LOGIC ---
            const allIssues = useMemo(() => {
                const issues = [];
                inspections.forEach(insp => {
                    Object.entries(insp.respostas).forEach(([qId, val]) => {
                        if (val === 'NC') {
                            const resolutionKey = `${insp.id}_${qId}`;
                            const resolution = resolutions.find(r => r.id === resolutionKey);
                            const question = questions.find(q => q.id === qId);
                            
                            const previousRecurrences = inspections.filter(i => 
                                i.setor === insp.setor && 
                                new Date(i.data) < new Date(insp.data) &&
                                i.respostas[qId] === 'NC'
                            ).length;

                            issues.push({
                                id: resolutionKey,
                                inspectionId: insp.id,
                                questionId: qId,
                                date: insp.data,
                                setor: insp.setor,
                                question: question ? question.pergunta : 'Removida',
                                obs: insp.observacoes[qId],
                                recurrence: previousRecurrences,
                                status: resolution ? resolution.status : 'PENDING',
                                deadline: resolution ? resolution.deadline : '',
                                actionNote: resolution ? resolution.actionNote : '',
                                resolvedDate: resolution ? resolution.resolvedDate : '' 
                            });
                        }
                    });
                });
                return issues.sort((a,b) => new Date(b.date) - new Date(a.date));
            }, [inspections, resolutions, questions]);

            const groupedIssues = useMemo(() => {
                const pending = {};
                const resolved = {};
                
                allIssues.forEach(issue => {
                    if (issue.status !== 'RESOLVED') {
                        if (!pending[issue.setor]) pending[issue.setor] = [];
                        pending[issue.setor].push(issue);
                    } else {
                        if (!resolved[issue.setor]) resolved[issue.setor] = [];
                        resolved[issue.setor].push(issue);
                    }
                });
                
                return { pending, resolved };
            }, [allIssues]);

            const filteredResolvedIssues = useMemo(() => {
                const source = groupedIssues.resolved;
                const filtered = {};

                if (!source) return {}; 

                Object.entries(source).forEach(([setor, issues]) => {
                    const issuesMatchingDate = followupHistoryDate 
                        ? issues.filter(i => i.date.startsWith(followupHistoryDate)) 
                        : issues;

                    const sectorMatches = setor.toLowerCase().includes(followupHistorySearch.toLowerCase());

                    if (issuesMatchingDate.length > 0 && sectorMatches) {
                        filtered[setor] = issuesMatchingDate;
                    }
                });
                
                return filtered;
            }, [groupedIssues.resolved, followupHistorySearch, followupHistoryDate]);
            
            const metrics = useMemo(() => {
                const stats = {};
                allIssues.forEach(issue => {
                    if (!stats[issue.setor]) stats[issue.setor] = { total: 0, resolved: 0, resolvedLate: 0, points: 0 };
                    stats[issue.setor].total++;
                    
                    if (issue.status === 'RESOLVED') {
                        stats[issue.setor].resolved++;
                        const isLate = issue.deadline && issue.resolvedDate && issue.resolvedDate > issue.deadline;
                        
                        if (isLate) {
                            stats[issue.setor].resolvedLate++;
                            stats[issue.setor].points += 0.5; 
                        } else {
                            stats[issue.setor].points += 1; 
                        }
                    } 
                });
                
                return Object.entries(stats).map(([setor, data]) => ({
                    setor,
                    ...data,
                    efficiency: Math.round((data.points / data.total) * 100) || 0
                })).sort((a, b) => b.efficiency - a.efficiency);
            }, [allIssues]);

            const handleUpdateResolution = async (issueId, updates) => {
                const currentRes = resolutions.find(r => r.id === issueId) || { id: issueId };
                
                if (updates.status === 'RESOLVED') {
                    updates.resolvedDate = new Date().toISOString().split('T')[0];
                }
                
                const newRes = { ...currentRes, ...updates };
                await IDB.saveResolution(newRes);
                setResolutions(prev => {
                    const idx = prev.findIndex(r => r.id === issueId);
                    if (idx >= 0) {
                        const newArr = [...prev];
                        newArr[idx] = newRes;
                        return newArr;
                    }
                    return [...prev, newRes];
                });
                
                const msg = updates.status === 'RESOLVED' ? "Resolvido!" : "Atualizado!";
                toast(msg, 'success');
            };

            const handleStartInspection = (setor) => {
                if (!responsavel) { toast("Informe o responsável para iniciar.", 'error'); return; }
                setSelectedSetor(setor);
                setAnswers({});
                setObs({});
                setEvidences({});
                setSignature(null);
                setEditingInspectionId(null);
                setInspectionSearch('');
                const now = new Date();
                now.setDate(now.getDate() + (weekOffset * 7));
                const localDate = getLocalDateString(now);
                setInspectionDate(localDate);
                
                const sortedInspections = inspections
                    .filter(i => i.setor === setor)
                    .sort((a, b) => new Date(b.data) - new Date(a.data));
                
                const lastInsp = sortedInspections[0];
                const prevNCsMap = {};
                if (lastInsp) {
                    Object.entries(lastInsp.respostas).forEach(([qId, val]) => {
                        if(val === 'NC') {
                            prevNCsMap[qId] = lastInsp.observacoes[qId] || "Sem observação";
                        }
                    });
                }
                setPreviousNCs(prevNCsMap);
                setView('inspection');
            };

            const handleEditInspection = (insp) => {
                setSelectedSetor(insp.setor);
                setResponsavel(insp.responsavel);
                setInspectionDate(insp.data.split('T')[0]); // Data vem ISO
                setAnswers(insp.respostas);
                setObs(insp.observacoes);
                setEvidences(insp.evidencias || {});
                setSignature(insp.assinatura);
                setEditingInspectionId(insp.id);
                setPreviousNCs({});
                setInspectionSearch('');
                setView('inspection');
            };

            const handleDeleteAudit = async (id) => {
                if (!confirm("Tem certeza que deseja apagar este registro?")) return;
                await IDB.deleteInspection(id);
                setInspections(prev => prev.filter(i => i.id !== id));
                toast("Inspeção apagada com sucesso.");
            };

            const handlePhotoUpload = (qId, e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressedBase64 = canvas.toDataURL("image/jpeg", 0.7); 
                        setEvidences(prev => {
                            const currentList = prev[qId] ? (Array.isArray(prev[qId]) ? prev[qId] : [prev[qId]]) : [];
                            return { ...prev, [qId]: [...currentList, compressedBase64] };
                        });
                        toast("Foto adicionada!", 'success');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            };

            const removePhoto = (qId, index) => {
                setEvidences(prev => {
                    const currentList = prev[qId] ? (Array.isArray(prev[qId]) ? prev[qId] : [prev[qId]]) : [];
                    const newList = currentList.filter((_, i) => i !== index);
                    return { ...prev, [qId]: newList };
                });
            };

            const handleSaveSignature = (sigData) => {
                setSignature(sigData);
                setIsSigning(false);
            };

            const handleSaveInspection = async () => {
                try {
                    const pendentes = currentQuestions.filter(q => !answers[q.id]);
                    if (pendentes.length > 0 && !confirm(`Existem ${pendentes.length} perguntas sem resposta. Salvar mesmo assim?`)) return;
                    if (!signature && !confirm("Salvar sem assinatura?")) return;

                    const targetWeekId = getWeekID(inspectionDate, 0); 
                    
                    const dataIsoSalva = inspectionDate + 'T12:00:00.000Z';

                    const newInspection = {
                        id: editingInspectionId || Date.now().toString(),
                        setor: selectedSetor,
                        responsavel: responsavel,
                        data: dataIsoSalva,
                        weekId: targetWeekId,
                        score: scores.real,
                        bonusScore: scores.bonus,
                        respostas: answers,
                        observacoes: obs,
                        evidencias: evidences,
                        assinatura: signature,
                        status: 'Concluído'
                    };

                    await IDB.saveInspection(newInspection);
                    await IDB.setConfig('current_draft', null); 

                    if (editingInspectionId) {
                        setInspections(prev => prev.map(i => i.id === editingInspectionId ? newInspection : i));
                    } else {
                        setInspections(prev => [...prev, newInspection]);
                    }
                    
                    const ncs = Object.entries(newInspection.respostas).filter(([_, v]) => v === 'NC');
                    let sugestao = "Parabéns! Nenhuma não conformidade detectada.";
                    
                    if (ncs.length > 0) {
                        sugestao = ncs.map(([qid]) => {
                            const q = questions.find(qu => qu.id === qid);
                            return `- Resolver NC em ${q?.grupo || 'Geral'}: ${q?.pergunta || 'Item'} (Obs: ${newInspection.observacoes[qid] || ' '})`;
                        }).join('\n');
                    }
                    setActionPlan(sugestao);

                    setReportInspection(newInspection);
                    setView('report');
                    toast("Inspeção salva com sucesso!");
                } catch (e) {
                    console.error(e);
                    toast("Erro ao salvar inspeção. Tente novamente.", 'error');
                }
            };

            const handleCancelInspection = async () => {
                 if (confirm("Deseja cancelar esta inspeção? Todos os dados não salvos serão perdidos.")) {
                     await IDB.setConfig('current_draft', null); 
                     setView('dashboard');
                 }
            };

            const handleSaveQuestion = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const weight = parseInt(formData.get('weight')) || 1;
                const newQ = {
                    id: editingQ?.id || Date.now().toString(),
                    setor: formData.get('setor').toUpperCase(),
                    grupo: formData.get('grupo').toUpperCase(),
                    pergunta: formData.get('pergunta'),
                    critical: formData.get('critical') === 'on',
                    weight: weight
                };
                let newQuestions = editingQ ? questions.map(q => q.id === editingQ.id ? newQ : q) : [...questions, newQ];
                
                await IDB.setConfig('questions', newQuestions);
                setQuestions(newQuestions);
                setIsModalOpen(false);
                setEditingQ(null);
                toast("Pergunta salva.");
            };

            const handleNextWeek = async () => {
                if (confirm("Deseja iniciar a próxima semana de auditorias?\n\nIsso limpará a tela inicial para novos registros, mas manterá todo o histórico salvo. A data base do sistema avançará 1 semana.")) {
                    const newOffset = weekOffset + 1;
                    await IDB.setConfig('weekOffset', newOffset);
                    setWeekOffset(newOffset);
                    toast("Nova semana iniciada!", 'success');
                }
            };

            const handleExportCSV = () => {
                const headers = ["ID", "Data", "Semana", "Setor", "Responsavel", "Nota", "Questão", "Grupo", "Peso", "Resposta", "Observação"];
                const rows = [];
                inspections.forEach(insp => {
                    Object.entries(insp.respostas).forEach(([qId, resp]) => {
                        const q = questions.find(qu => qu.id === qId);
                        rows.push([
                            insp.id,
                            new Date(insp.data).toLocaleDateString(),
                            insp.weekId,
                            insp.setor,
                            insp.responsavel,
                            insp.score,
                            q ? q.pergunta.replace(/;/g, ',') : 'Questão removida',
                            q ? q.grupo : '-',
                            q ? (q.weight || 1) : 1,
                            resp,
                            (insp.observacoes[qId] || '').replace(/;/g, ',')
                        ]);
                    });
                });

                const csvContent = "data:text/csv;charset=utf-8," 
                    + headers.join(";") + "\n" 
                    + rows.map(e => e.join(";")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "imac_dados_brutos.csv");
                document.body.appendChild(link);
                link.click();
                toast("Download iniciado!");
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = async () => {
                    await IDB.setConfig('logo', reader.result);
                    setLogo(reader.result);
                    toast("Logo atualizada.");
                };
                reader.readAsDataURL(file);
            };

            // PDF Download Handler
            const handleDownloadPDF = (elementId, filename, isLandscape = false) => { 
                const element = document.getElementById(elementId);
                const opt = {
                    margin: 5,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: isLandscape ? 'landscape' : 'portrait' }
                };
                if (window.html2pdf) {
                     window.html2pdf().set(opt).from(element).save();
                } else {
                    toast("Biblioteca PDF não carregada. Tente recarregar a página.", 'error');
                }
            };

            const handleDownloadBackup = async () => {
                try {
                    const inspections = await IDB.getAllInspections();
                    const questions = await IDB.getConfig('questions');
                    const logo = await IDB.getConfig('logo');
                    const offset = await IDB.getConfig('weekOffset');
                    const backupData = {
                        version: 1,
                        timestamp: new Date().toISOString(),
                        inspections,
                        questions,
                        logo,
                        weekOffset: offset || 0
                    };
                    
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_imac_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    const now = new Date().toISOString();
                    await IDB.setConfig('lastBackup', now);
                    setLastBackup(now);
                    toast("Backup realizado com sucesso!");
                } catch (e) {
                    console.error(e);
                    toast("Erro ao gerar backup.", 'error');
                }
            };

            const handleRestoreBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.inspections || !Array.isArray(data.inspections)) {
                            throw new Error("Formato inválido");
                        }
                        
                        if (confirm(`Restaurar backup de ${new Date(data.timestamp).toLocaleString()}? Isso substituirá os dados atuais.`)) {
                            if (data.questions) { await IDB.setConfig('questions', data.questions); setQuestions(data.questions); }
                            if (data.logo) { await IDB.setConfig('logo', data.logo); setLogo(data.logo); }
                            if (data.weekOffset !== undefined) { await IDB.setConfig('weekOffset', data.weekOffset); setWeekOffset(data.weekOffset); }
                            
                            for (const insp of data.inspections) { await IDB.saveInspection(insp); }
                            
                            setInspections(await IDB.getAllInspections());
                            toast("Dados restaurados com sucesso!");
                        }
                    } catch (err) {
                        console.error(err);
                        toast("Erro ao restaurar backup. Arquivo inválido.", 'error');
                    }
                };
                reader.readAsText(file);
            };

            const filteredInspectionQuestions = useMemo(() => {
                if (!inspectionSearch) return currentQuestions;
                const lower = inspectionSearch.toLowerCase();
                return currentQuestions.filter(q => 
                    q.pergunta.toLowerCase().includes(lower) || 
                    q.grupo.toLowerCase().includes(lower)
                );
            }, [currentQuestions, inspectionSearch]);

            const analytics = useMemo(() => {
                let filteredInspections = [];
                if (analyticsTab === 'weekly') {
                    const targetWeekId = getWeekID(analyticsSelectedDate);
                    filteredInspections = inspections.filter(i => i.weekId === targetWeekId);
                } else {
                    filteredInspections = inspections.filter(i => i.data.startsWith(selectedMonth));
                }

                const totalScore = filteredInspections.reduce((acc, curr) => acc + (curr.score || 0), 0);
                const avgScore = filteredInspections.length ? Math.round(totalScore / filteredInspections.length) : 0;
                
                const totalBonusScore = filteredInspections.reduce((acc, curr) => acc + (curr.bonusScore !== undefined ? curr.bonusScore : curr.score || 0), 0);
                const avgBonusScore = filteredInspections.length ? Math.round(totalBonusScore / filteredInspections.length) : 0;

                // RANKING - AGORA SEMPRE PELA GRATIFICAÇÃO (BÔNUS)
                const grouped = {};
                filteredInspections.forEach(i => {
                    if(!grouped[i.setor]) grouped[i.setor] = { total: 0, count: 0 };
                    // Usa sempre o bonusScore (ou score se não tiver bonus) para somar
                    grouped[i.setor].total += (i.bonusScore !== undefined ? i.bonusScore : i.score || 0);
                    grouped[i.setor].count += 1;
                });
                
                let ranking = Object.entries(grouped).map(([setor, val]) => ({
                    setor, 
                    score: Math.round(val.total / val.count), // Esta agora é a média da gratificação
                    count: val.count
                })).sort((a, b) => b.score - a.score);

                const ncBySector = {};
                const ncByCategory = {};
                const inspectionsByAuditor = {};
                const auditorScores = {}; 

                filteredInspections.forEach(insp => {
                    inspectionsByAuditor[insp.responsavel] = (inspectionsByAuditor[insp.responsavel] || 0) + 1;
                    if (!auditorScores[insp.responsavel]) auditorScores[insp.responsavel] = { total: 0, count: 0 };
                    // Auditor também avaliado pela gratificação
                    auditorScores[insp.responsavel].total += (insp.bonusScore !== undefined ? insp.bonusScore : insp.score || 0);
                    auditorScores[insp.responsavel].count += 1;

                    if(insp.respostas) {
                        Object.entries(insp.respostas).forEach(([qId, resp]) => {
                            if (resp === 'NC') {
                                ncBySector[insp.setor] = (ncBySector[insp.setor] || 0) + 1;
                                const question = questions.find(q => q.id === qId);
                                if (question) {
                                    ncByCategory[question.grupo] = (ncByCategory[question.grupo] || 0) + 1;
                                }
                            }
                        });
                    }
                });

                const colors = ['#eab308', '#a8a29e', '#f59e0b', '#78716c', '#ef4444', '#84cc16', '#3b82f6', '#d946ef'];
                
                const pieSector = Object.entries(ncBySector)
                    .map(([label, value], i) => ({ label, value, color: colors[i % colors.length] }))
                    .sort((a, b) => b.value - a.value); 

                const pieCategory = Object.entries(ncByCategory)
                    .map(([label, value], i) => ({ label, value, color: colors[i % colors.length] }))
                    .sort((a, b) => b.value - a.value); 

                const pieAuditor = Object.entries(inspectionsByAuditor)
                    .map(([label, value], i) => ({ label, value, color: colors[i % colors.length] }))
                    .sort((a, b) => b.value - a.value); 
                
                const auditorPerformance = Object.entries(auditorScores).map(([name, val]) => ({
                    name,
                    avg: Math.round(val.total / val.count),
                    count: val.count
                })).sort((a, b) => b.avg - a.avg);

                const totalInspections = filteredInspections.length;
                const bestSector = ranking.length > 0 ? ranking[0].setor : "Nenhum";
                const worstSector = ranking.length > 0 ? ranking[ranking.length - 1].setor : "Nenhum";
                const mainIssue = pieCategory.length > 0 ? pieCategory[0].label : "Nenhum";

                const summaryText = `Neste período (${analyticsTab === 'weekly' ? 'Semana' : 'Mês'}), foram realizadas ${totalInspections} inspeções, resultando em uma média global de ${avgScore}%. O setor com melhor desempenho foi "${bestSector}", enquanto "${worstSector}" apresentou os menores índices. A principal categoria de não conformidades foi "${mainIssue}".`;

                return { avgScore, avgBonusScore, ranking, pieSector, pieCategory, pieAuditor, auditorPerformance, summaryText, filteredInspections };
            }, [inspections, questions, weekId, analyticsTab, selectedMonth, analyticsSelectedDate]);

            if (view === 'loading') return <div className="flex h-screen bg-stone-100 items-center justify-center flex-col gap-4"><div className="animate-spin rounded-full h-12 w-12 border-b-4 border-yellow-500"></div><p className="text-stone-500 font-bold animate-pulse">Carregando Sistema...</p></div>;

            // RENDERIZAÇÃO DAS TELAS
            return (
                <div className={view === 'management_report' || view === 'report' ? "min-h-screen bg-white" : "max-w-md mx-auto min-h-screen bg-stone-100 flex flex-col text-stone-900 shadow-2xl relative"}>
                    
                    {/* LIGHTBOX (Só renderiza se não for report) */}
                    {view !== 'management_report' && view !== 'report' && <Lightbox src={lightboxImg} onClose={() => setLightboxImg(null)} />}

                    {/* VIEW: DASHBOARD */}
                    {view === 'dashboard' && (
                        <>
                            <header className="bg-gradient-to-b from-yellow-500 to-yellow-600 text-stone-900 p-6 rounded-b-3xl shadow-lg mb-6 relative border-b border-yellow-600/30">
                                <div className="absolute top-6 right-6 flex gap-2">
                                    {/* Link para Pendências */}
                                    <button onClick={() => setView('followup')} className="p-2 bg-white/30 rounded-full hover:bg-white/50 text-stone-900 transition-colors relative" title="Pendências">
                                        <Icons.Alert />
                                        {Object.keys(groupedIssues.pending).length > 0 && <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border border-white"></span>}
                                    </button>
                                    <button onClick={() => { setSettingsTab('history'); setView('settings'); }} className="p-2 bg-white/30 rounded-full hover:bg-white/50 text-stone-900 transition-colors" title="Histórico"><Icons.History /></button>
                                    <button onClick={() => setView('analytics')} className="p-2 bg-white/30 rounded-full hover:bg-white/50 text-stone-900 transition-colors" title="Indicadores"><Icons.Chart /></button>
                                    <button onClick={() => setView('settings')} className="p-2 bg-white/30 rounded-full hover:bg-white/50 text-stone-900 hover:text-stone-700 transition-colors" title="Configurações"><Icons.Gear /></button>
                                </div>
                                <div className="mb-4">
                                    {logo ? <img src={logo} alt="Logo" className="h-16 object-contain mb-2 drop-shadow-md" /> : <h1 className="text-2xl font-bold text-stone-900">Gestão IMAC</h1>}
                                    <p className="text-stone-800 text-sm font-medium">Controle de Qualidade</p>
                                </div>
                                <div className="bg-white/90 backdrop-blur-md p-4 rounded-xl border border-yellow-200 shadow-sm">
                                    <div className="flex justify-between items-end mb-2">
                                        <span className="text-stone-600 text-sm font-bold">Progresso Semanal</span>
                                        <span className="text-2xl font-bold text-yellow-600">{progress.pct}%</span>
                                    </div>
                                    <div className="w-full bg-stone-200 rounded-full h-3 mb-2"><div className="bg-yellow-500 h-3 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(234,179,8,0.5)]" style={{ width: `${progress.pct}%` }}></div></div>
                                    <p className="text-xs text-stone-500 text-right font-medium">{progress.done}/{progress.total} setores verificados</p>
                                </div>
                            </header>
                            <main className="flex-1 px-6 pb-20 animate-fade-in">
                                <div className="mb-6"><label className="block text-sm font-bold text-stone-700 mb-2">Responsável</label><input type="text" value={responsavel} onChange={(e) => setResponsavel(e.target.value)} placeholder="Digite seu nome..." className="w-full p-3 rounded-xl bg-white border border-stone-300 text-stone-900 shadow-sm outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent placeholder-stone-400 transition-all" /></div>
                                
                                {/* CARD DE CONCLUSÃO DA SEMANA */}
                                {progress.pct === 100 && (
                                    <div className="mb-6 p-5 bg-green-50 rounded-xl border border-green-200 text-center animate-fade-in shadow-sm">
                                        <h3 className="text-green-700 font-bold text-lg mb-2">🎉 Semana Concluída!</h3>
                                        <p className="text-green-800 text-xs mb-4 leading-relaxed">
                                            Todos os setores foram verificados. Você pode iniciar a próxima semana manualmente ou aguardar a segunda-feira.
                                        </p>
                                        <div className="flex flex-col gap-2">
                                            <button 
                                                onClick={() => setView('management_report')} 
                                                className="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-500 transition-all flex items-center justify-center gap-2 active:scale-95"
                                            >
                                                <Icons.FileText /> Ver Relatório Semanal
                                            </button>
                                            <button 
                                                onClick={handleNextWeek} 
                                                className="w-full py-3 bg-white border border-green-600 text-green-700 font-bold rounded-lg hover:bg-green-50 transition-all flex items-center justify-center gap-2 text-xs active:scale-95"
                                            >
                                                <Icons.ArrowRight /> Iniciar Próxima Semana (Avançar)
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-3">
                                    {allSetors.map(setor => {
                                        const isDone = setoresConcluidos.has(setor);
                                        const insp = inspectionsThisWeek.find(i => i.setor === setor);
                                        // Usando bonusScore se disponível, senão score (retrocompatibilidade)
                                        const displayScore = insp ? (insp.bonusScore !== undefined ? insp.bonusScore : insp.score) : 0;
                                        
                                        return (
                                            <button key={setor} onClick={() => isDone ? (setReportInspection(insp), setView('report')) : handleStartInspection(setor)} className={`w-full p-4 rounded-xl flex items-center justify-between card-shadow transition-all active:scale-95 border ${isDone ? 'bg-white border-yellow-500 shadow-md' : 'bg-white border-stone-200 hover:border-stone-400'}`}>
                                                <div className="flex items-center gap-3">
                                                    <div className={`h-10 w-10 rounded-full flex items-center justify-center ${isDone ? 'bg-yellow-100 text-yellow-700' : 'bg-stone-100 text-stone-500'}`}>{isDone ? <Icons.Check /> : <Icons.List />}</div>
                                                    <div className="text-left"><p className={`font-bold ${isDone ? 'text-stone-900' : 'text-stone-700'}`}>{setor}</p>{isDone && <div className="flex gap-2 items-center"><p className={`text-xs font-bold ${displayScore >= 85 ? 'text-green-600' : 'text-red-600'}`}>Nota: {displayScore}%</p><StarRating score={displayScore} /></div>}</div>
                                                </div>
                                                {isDone ? <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-bold border border-yellow-200">RELATÓRIO</span> : <span className="h-8 w-8 rounded-full bg-stone-100 text-stone-400 flex items-center justify-center hover:bg-stone-200 hover:text-yellow-600 transition-colors">→</span>}
                                            </button>
                                        );
                                    })}
                                </div>
                            </main>
                        </>
                    )}

                    {/* VIEW: FOLLOW UP (PENDÊNCIAS) */}
                    {view === 'followup' && (
                        <div className="max-w-md mx-auto min-h-screen bg-stone-100 flex flex-col animate-fade-in text-stone-900">
                            <header className="bg-white p-4 flex items-center justify-between sticky top-0 z-10 shadow-md border-b border-stone-200">
                                <button onClick={() => setView('dashboard')} className="text-sm font-bold text-stone-500 hover:text-yellow-600 transition-colors">← Voltar</button>
                                <h1 className="font-bold text-yellow-600">Gestão de Pendências</h1>
                                <div className="w-10"></div>
                            </header>

                            {/* TABS DE NAVEGAÇÃO PENDÊNCIAS */}
                            <div className="flex border-b border-stone-200 bg-white p-2 gap-2 sticky top-[60px] z-10">
                                <button onClick={() => setFollowupTab('pending')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${followupTab === 'pending' ? 'bg-yellow-500 text-white' : 'bg-stone-100 text-stone-500 hover:bg-stone-200'}`}>Pendentes</button>
                                <button onClick={() => setFollowupTab('history')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${followupTab === 'history' ? 'bg-yellow-500 text-white' : 'bg-stone-100 text-stone-500 hover:bg-stone-200'}`}>Histórico</button>
                                <button onClick={() => setFollowupTab('metrics')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${followupTab === 'metrics' ? 'bg-yellow-500 text-white' : 'bg-stone-100 text-stone-500 hover:bg-stone-200'}`}>Eficiência</button>
                            </div>

                            <main className="flex-1 p-4 pb-20 space-y-6">
                                {followupTab === 'history' && (
                                    <div className="bg-white p-3 rounded-xl shadow-sm border border-stone-200 mb-4 animate-fade-in">
                                        <h3 className="text-xs font-bold text-stone-500 uppercase mb-2 flex items-center gap-1"><Icons.Search /> Filtrar Histórico</h3>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                placeholder="Buscar setor..." 
                                                value={followupHistorySearch}
                                                onChange={(e) => setFollowupHistorySearch(e.target.value)}
                                                className="flex-1 p-2 text-sm border border-stone-300 rounded-lg outline-none focus:border-yellow-500"
                                            />
                                            <input 
                                                type="date" 
                                                value={followupHistoryDate}
                                                onChange={(e) => setFollowupHistoryDate(e.target.value)}
                                                className="w-32 p-2 text-sm border border-stone-300 rounded-lg outline-none focus:border-yellow-500"
                                            />
                                        </div>
                                    </div>
                                )}

                                {followupTab === 'metrics' ? (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="bg-white p-4 rounded-xl shadow-sm border border-stone-200">
                                            <h3 className="text-sm font-bold text-stone-700 mb-4 flex items-center gap-2"><Icons.TrendingUp /> Eficiência por Setor</h3>
                                            <p className="text-[10px] text-stone-500 mb-4 italic">Nota: Resoluções fora do prazo contam apenas 50% na eficiência.</p>
                                            <div className="space-y-4">
                                                {metrics.map((m, i) => (
                                                    <div key={i}>
                                                        <div className="flex justify-between text-xs mb-1">
                                                            <span className="font-bold text-stone-700">{m.setor}</span>
                                                            <span className="font-bold text-stone-500">
                                                                {m.efficiency}% ({m.resolved}/{m.total}) 
                                                                {m.resolvedLate > 0 && <span className="text-red-500 ml-1">({m.resolvedLate} com atraso)</span>}
                                                            </span>
                                                        </div>
                                                        <div className="w-full bg-stone-200 rounded-full h-2">
                                                            <div className={`h-2 rounded-full ${m.efficiency >= 80 ? 'bg-green-500' : m.efficiency >= 50 ? 'bg-yellow-500' : 'bg-red-500'}`} style={{ width: `${m.efficiency}%` }}></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    Object.keys(followupTab === 'pending' ? groupedIssues.pending : filteredResolvedIssues).length === 0 ? (
                                        <div className="flex flex-col items-center justify-center h-64 text-stone-400">
                                            <div className="bg-green-100 p-4 rounded-full text-green-500 mb-3"><Icons.Check /></div>
                                            <p className="font-bold text-stone-600">{followupTab === 'pending' ? 'Tudo em dia!' : 'Nenhum histórico encontrado.'}</p>
                                            <p className="text-xs">{followupTab === 'pending' ? 'Nenhuma pendência em aberto.' : 'Ajuste os filtros de busca.'}</p>
                                        </div>
                                    ) : (
                                        Object.entries(followupTab === 'pending' ? groupedIssues.pending : filteredResolvedIssues).map(([setor, issues]) => (
                                            <div key={setor} className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden animate-fade-in">
                                                <div className="bg-stone-50 px-4 py-3 border-b border-stone-200 flex justify-between items-center">
                                                    <h3 className="font-bold text-stone-800 flex items-center gap-2">
                                                        {setor}
                                                    </h3>
                                                    <span className={`text-[10px] font-bold px-2 py-1 rounded-full border ${followupTab === 'pending' ? 'bg-red-100 text-red-600 border-red-200' : 'bg-green-100 text-green-600 border-green-200'}`}>{issues.length} {followupTab === 'pending' ? 'Pendentes' : 'Resolvidos'}</span>
                                                </div>
                                                <div className="divide-y divide-stone-100">
                                                    {issues.map(issue => {
                                                        const today = new Date().toISOString().split('T')[0];
                                                        const isLate = issue.deadline && issue.deadline < today && issue.status !== 'RESOLVED';
                                                        const isToday = issue.deadline === today && issue.status !== 'RESOLVED';
                                                        
                                                        return (
                                                            <div key={issue.id} className="p-4 relative">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <span className="text-[10px] font-bold text-stone-400 uppercase flex items-center gap-1">
                                                                        <Icons.Calendar /> {formatDateDisplay(issue.date.split('T')[0])}
                                                                    </span>
                                                                    {issue.recurrence > 0 && <span className="text-[10px] font-bold text-white bg-red-500 px-2 py-0.5 rounded-full shadow-sm">Reincidente {issue.recurrence + 1}x</span>}
                                                                </div>

                                                                <p className="text-sm font-medium text-stone-800 mb-2 leading-tight">{issue.question}</p>
                                                                {issue.obs && <div className="text-xs text-stone-600 bg-stone-50 p-2 rounded border border-stone-200 mb-3 italic">Obs: {issue.obs}</div>}
                                                                
                                                                {followupTab === 'pending' ? (
                                                                    <div className="flex items-end gap-3 mt-3">
                                                                        <div className="flex-1">
                                                                            <label className={`block text-[10px] font-bold uppercase mb-1 ${isLate ? 'text-red-600' : isToday ? 'text-yellow-600' : 'text-stone-400'}`}>
                                                                                {isLate ? 'Prazo Vencido!' : isToday ? 'Vence Hoje!' : 'Prazo Limite'}
                                                                            </label>
                                                                            <input 
                                                                                type="date" 
                                                                                className={`w-full p-2 text-sm border rounded-lg outline-none transition-colors ${isLate ? 'border-red-500 bg-red-50 text-red-700' : isToday ? 'border-yellow-500 bg-yellow-50 text-yellow-800' : 'border-stone-300 focus:border-yellow-500'}`}
                                                                                value={issue.deadline} 
                                                                                onChange={(e) => handleUpdateResolution(issue.id, { deadline: e.target.value })} 
                                                                            />
                                                                        </div>
                                                                        <button 
                                                                            onClick={() => handleUpdateResolution(issue.id, { status: 'RESOLVED', actionNote: 'Resolvido via App' })} 
                                                                            className="h-10 px-4 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-500 active:scale-95 transition-all flex items-center gap-2 text-xs"
                                                                            title="Marcar como Resolvido"
                                                                        >
                                                                            <Icons.Check /> Resolver
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    <div className="mt-2 pt-2 border-t border-stone-100 flex justify-between items-center text-xs">
                                                                        <div>
                                                                            {/* Lógica Visual de Atraso no Histórico */}
                                                                            {issue.deadline && issue.resolvedDate > issue.deadline ? (
                                                                                <span className="text-orange-600 font-bold flex items-center gap-1"><Icons.Alert /> Resolvido com Atraso ({formatDateDisplay(issue.resolvedDate)})</span>
                                                                            ) : (
                                                                                <span className="text-green-700 font-bold flex items-center gap-1"><Icons.Check /> Resolvido no Prazo ({formatDateDisplay(issue.resolvedDate || issue.date)})</span>
                                                                            )}
                                                                        </div>
                                                                        <button onClick={() => handleUpdateResolution(issue.id, { status: 'PENDING' })} className="text-stone-400 underline hover:text-red-500 ml-2">Reabrir</button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))
                                    )
                                )}
                            </main>
                        </div>
                    )}

                    {/* VIEW: INSPECTION */}
                    {view === 'inspection' && (
                        <div className="flex flex-col h-screen">
                            <header className="sticky top-0 z-20 bg-white border-b border-stone-200 px-6 py-4 shadow-md">
                                <div className="flex justify-between items-start mb-2">
                                    <div><h2 className="text-lg font-bold text-stone-800">{selectedSetor}</h2><p className="text-xs text-stone-500">Resp: {responsavel}</p></div>
                                    <div className="text-right flex flex-col items-end">
                                        <label className="text-[10px] text-stone-400 font-bold uppercase">Data</label>
                                        <input type="date" value={inspectionDate} onChange={(e) => setInspectionDate(e.target.value)} className="bg-transparent text-stone-600 text-sm font-bold text-right outline-none focus:text-yellow-600" />
                                    </div>
                                </div>
                                <div className="flex justify-between items-center pt-2 border-t border-stone-200 mt-2">
                                    <div className="text-center w-1/2 border-r border-stone-200"><span className={`text-2xl font-black ${scores.real >= 85 ? 'text-green-600' : 'text-red-600'}`}>{scores.real}%</span><span className="text-[10px] font-bold text-stone-400 block uppercase">Real</span></div>
                                    <div className="text-center w-1/2"><span className="text-xl font-bold text-yellow-600">{scores.bonus}%</span><span className="text-[10px] font-bold text-yellow-700 block uppercase">Bônus</span></div>
                                </div>
                            </header>
                            
                            <div className="bg-stone-100 p-4 pb-2 sticky top-[130px] z-10">
                                <div className="relative shadow-sm">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-stone-400"><Icons.Search /></div>
                                    <input type="text" value={inspectionSearch} onChange={(e) => setInspectionSearch(e.target.value)} placeholder="Busca rápida (ex: lixo, pia, teto)..." className="w-full pl-10 p-3 bg-white border border-stone-300 rounded-xl text-stone-800 outline-none focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20 transition-all placeholder-stone-400" />
                                    {inspectionSearch && <button onClick={() => setInspectionSearch('')} className="absolute inset-y-0 right-0 pr-3 flex items-center text-stone-400 hover:text-stone-600 font-bold">✕</button>}
                                </div>
                            </div>

                            <main className="flex-1 p-6 pt-2 space-y-6 overflow-y-auto pb-24">
                                {filteredInspectionQuestions.length === 0 ? <p className="text-center text-stone-500 py-10">Nenhuma pergunta encontrada.</p> : 
                                filteredInspectionQuestions.map((q, idx) => {
                                    const prevNC = previousNCs[q.id];
                                    return (
                                    <div key={q.id || idx} className="animate-fade-in bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                                        <div className="mb-2">
                                            <div className="flex gap-2">
                                                <span className="text-[10px] font-bold text-yellow-700 bg-yellow-100 border border-yellow-200 px-2 py-1 rounded uppercase">{q.grupo}</span>
                                                {q.critical && <span className="text-[10px] font-bold text-white bg-red-600 px-2 py-1 rounded uppercase flex items-center gap-1"><Icons.Alert /> CRÍTICO</span>}
                                                <span className="text-[10px] font-bold text-stone-600 bg-stone-200 border border-stone-300 px-2 py-1 rounded uppercase">Peso: {q.weight || 1}</span>
                                            </div>
                                            <p className="mt-2 text-stone-800 font-medium leading-snug">{q.pergunta}</p>
                                        </div>
                                        {prevNC && <div className="mb-3 p-2 bg-yellow-50 border-l-2 border-yellow-400 rounded-r text-xs text-yellow-800 flex gap-2 items-start"><Icons.Alert /><div><span className="font-bold block text-yellow-700">Recorrente:</span> "{prevNC}"</div></div>}
                                        <div className="flex gap-2">
                                            {['C', 'NC', 'NA'].map(opt => (
                                                <button key={opt} onClick={() => setAnswers(p => ({...p, [q.id]: opt}))} className={`flex-1 py-3 rounded-lg font-bold text-sm transition-all shadow-sm ${answers[q.id] === opt ? (opt === 'C' ? 'bg-green-600 text-white shadow-md' : opt === 'NC' ? 'bg-red-600 text-white shadow-md' : 'bg-stone-500 text-white') : 'bg-white border border-stone-300 text-stone-500 hover:bg-stone-50'}`}>{opt}</button>
                                            ))}
                                        </div>
                                        {answers[q.id] === 'NC' && (
                                            <div className="mt-2 space-y-2 animate-fade-in">
                                                <input type="text" placeholder="Descreva o problema..." value={obs[q.id] || ''} onChange={(e) => setObs(p => ({...p, [q.id]: e.target.value}))} className="w-full text-sm p-3 bg-red-50 border-red-200 rounded-lg text-red-800 focus:border-red-400 outline-none border placeholder-red-300" />
                                                
                                                {/* Galeria de Fotos Já Adicionadas */}
                                                {evidences[q.id] && evidences[q.id].length > 0 && (
                                                    <div className="flex gap-2 overflow-x-auto py-2">
                                                        {evidences[q.id].map((img, i) => (
                                                            <div key={i} className="relative w-16 h-16 shrink-0 group cursor-pointer" onClick={() => setLightboxImg(img)}>
                                                                <img src={img} className="w-full h-full object-cover rounded border border-stone-300" />
                                                                <button onClick={(e) => {e.stopPropagation(); removePhoto(q.id, i)}} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow-md w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-red-600">x</button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                {/* Botões Separados: Câmera e Galeria */}
                                                <div className="flex gap-2">
                                                    <label className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border border-dashed border-stone-400 text-stone-600 bg-white hover:bg-stone-50 cursor-pointer transition-colors shadow-sm">
                                                        <input type="file" accept="image/*" capture="environment" className="hidden" onChange={(e) => handlePhotoUpload(q.id, e)} />
                                                        <Icons.Camera /> <span className="text-xs font-bold">Câmera</span>
                                                    </label>
                                                    <label className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border border-dashed border-stone-400 text-stone-600 bg-white hover:bg-stone-50 cursor-pointer transition-colors shadow-sm">
                                                        <input type="file" accept="image/*" className="hidden" onChange={(e) => handlePhotoUpload(q.id, e)} />
                                                        <Icons.Image /> <span className="text-xs font-bold">Galeria</span>
                                                    </label>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    );})
                                }
                                <div className="mt-8 border-t border-stone-300 pt-6 bg-white p-4 rounded-xl">
                                    <h3 className="text-sm font-bold text-stone-700 mb-2 flex items-center gap-2"><Icons.Pen /> Assinatura</h3>
                                    <button 
                                        type="button" 
                                        onClick={(e) => { e.preventDefault(); setIsSigning(true); }} 
                                        className={`w-full py-3 rounded-lg border border-stone-300 flex items-center justify-center gap-2 transition-all ${signature ? 'bg-green-50 text-green-600 border-green-500' : 'bg-white text-stone-600 hover:bg-stone-50'}`}
                                    >
                                        {signature ? <><Icons.Check /> Assinatura Registrada</> : <><Icons.Pen /> Assinar</>}
                                    </button>
                                    {signature && <img src={signature} className="mt-2 h-12 object-contain opacity-70" />}
                                </div>
                            </main>
                            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-stone-200 flex gap-3 max-w-md mx-auto shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30">
                                <button onClick={handleCancelInspection} className="px-6 py-3 rounded-xl border border-stone-300 font-bold text-stone-500 hover:bg-stone-50">Cancelar</button>
                                <button onClick={handleSaveInspection} className="flex-1 bg-yellow-500 text-white rounded-xl font-bold shadow-lg shadow-yellow-500/20 hover:bg-yellow-600 transition-colors">Salvar Inspeção</button>
                            </div>
                        </div>
                    )}

                    {/* VIEW: SETTINGS */}
                    {view === 'settings' && (
                        <div className="min-h-screen bg-stone-100 flex flex-col">
                            <header className="bg-white p-4 flex items-center justify-between sticky top-0 z-10 shadow-md border-b border-stone-200">
                                <button onClick={() => setView('dashboard')} className="text-sm font-bold text-stone-500 hover:text-yellow-600">← Voltar</button>
                                <h1 className="font-bold text-yellow-600">Configurações</h1>
                                <div className="w-10"></div>
                            </header>
                            <div className="flex border-b border-stone-200 bg-white sticky top-[60px] z-10">
                                <button onClick={() => setSettingsTab('history')} className={`flex-1 py-3 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'history' ? 'border-yellow-500 text-yellow-600' : 'border-transparent text-stone-500'}`}>Histórico</button>
                                <button onClick={() => setSettingsTab('questions')} className={`flex-1 py-3 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'questions' ? 'border-yellow-500 text-yellow-600' : 'border-transparent text-stone-500'}`}>Perguntas</button>
                                <button onClick={() => setSettingsTab('system')} className={`flex-1 py-3 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'system' ? 'border-yellow-500 text-yellow-600' : 'border-transparent text-stone-500'}`}>Sistema</button>
                            </div>
                            <main className="flex-1 p-6 pb-24 space-y-4">
                                {settingsTab === 'system' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                            <h2 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Icons.Database /> Backup e Restauração</h2>
                                            <div className="mb-4 text-xs text-stone-500 bg-stone-50 p-3 rounded border border-stone-200"><p>Último Backup: <strong className="text-yellow-600">{lastBackup ? new Date(lastBackup).toLocaleString() : "Nunca realizado"}</strong></p></div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button onClick={handleDownloadBackup} className="flex flex-col items-center justify-center p-3 bg-white border border-stone-300 rounded-lg text-stone-600 hover:bg-stone-50 hover:text-yellow-600 transition-all active:scale-95"><Icons.Download /><span className="text-xs font-bold mt-2">Baixar Backup JSON</span></button>
                                                <label className="flex flex-col items-center justify-center p-3 bg-white border border-stone-300 rounded-lg text-stone-600 hover:bg-stone-50 hover:text-green-600 transition-all cursor-pointer active:scale-95"><Icons.Upload /><span className="text-xs font-bold mt-2">Restaurar Backup</span><input type="file" accept=".json" className="hidden" onChange={handleRestoreBackup} /></label>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                            <h2 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Icons.Excel /> Exportação de Dados</h2>
                                            <p className="text-xs text-stone-500 mb-4">Baixe todos os dados para analisar no Excel.</p>
                                            <button onClick={handleExportCSV} className="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 flex items-center justify-center gap-2"><Icons.Download /> Baixar CSV / Excel</button>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                                            <h2 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Icons.Image /> Logo</h2>
                                            <label className="block w-full p-4 border-2 border-dashed border-stone-300 rounded-lg text-center cursor-pointer hover:bg-stone-50">
                                                <input type="file" accept="image/*" onChange={handleLogoUpload} className="hidden" />
                                                {logo ? <img src={logo} className="h-12 mx-auto object-contain" /> : <span className="text-stone-400 text-xs font-bold">Clique para enviar logo</span>}
                                            </label>
                                        </div>
                                    </div>
                                )}
                                {settingsTab === 'questions' && (
                                    <div className="space-y-4">
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-stone-400"><Icons.Search /></div>
                                            <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Buscar pergunta..." className="w-full pl-10 p-3 bg-white border border-stone-300 rounded-xl outline-none focus:border-yellow-500" />
                                        </div>
                                        <div className="space-y-3">
                                            {questions.filter(q => q.pergunta.toLowerCase().includes(searchTerm.toLowerCase())).map(q => (
                                                <div key={q.id} className="bg-white p-4 rounded-xl shadow-sm border border-stone-200 flex justify-between items-start">
                                                    <div className="flex-1 pr-2">
                                                        <div className="flex gap-2 mb-1">
                                                            <span className="text-[10px] bg-stone-100 px-2 rounded border">{q.setor}</span>
                                                            {q.critical && <span className="text-[10px] bg-red-600 text-white px-2 rounded">CRÍTICO</span>}
                                                            {(q.weight > 1) && <span className="text-[10px] bg-blue-100 text-blue-800 px-2 rounded border border-blue-200">Peso {q.weight}</span>}
                                                        </div>
                                                        <p className="text-sm font-medium">{q.pergunta}</p>
                                                    </div>
                                                    <button onClick={() => { setEditingQ(q); setIsModalOpen(true); }} className="p-2 bg-stone-100 rounded text-stone-500"><Icons.Edit /></button>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={() => { setEditingQ(null); setIsModalOpen(true); }} className="fixed bottom-6 right-6 bg-yellow-500 text-white h-14 w-14 rounded-full shadow-lg flex items-center justify-center hover:bg-yellow-600 z-20"><Icons.Plus /></button>
                                    </div>
                                )}
                                {settingsTab === 'history' && (
                                    <div className="space-y-3">
                                        {inspections.sort((a,b) => new Date(b.data) - new Date(a.data)).map(insp => (
                                            <div key={insp.id} className="bg-white p-4 rounded-xl shadow-sm border border-stone-200 flex justify-between items-center">
                                                <div>
                                                    <div className="font-bold">{insp.setor}</div>
                                                    <div className="text-xs text-stone-500">{new Date(insp.data).toLocaleDateString()} • {insp.responsavel}</div>
                                                </div>
                                                <div className="flex gap-2 items-center">
                                                    <span className={`font-bold ${insp.score >= 85 ? 'text-green-600' : 'text-red-600'}`}>{insp.score}%</span>
                                                    <button onClick={() => handleDeleteAudit(insp.id)} className="p-2 bg-stone-100 rounded text-red-500"><Icons.Trash /></button>
                                                    <button onClick={() => { setReportInspection(insp); setView('report'); }} className="p-2 bg-stone-100 rounded text-stone-500"><Icons.FileText /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </main>
                        </div>
                    )}

                    {/* VIEW: ANALYTICS (CORREÇÃO: TELA RESTAURADA) */}
                    {view === 'analytics' && (
                        <div className="max-w-md mx-auto min-h-screen bg-stone-100 flex flex-col animate-fade-in text-stone-900">
                            <header className="bg-white p-4 flex items-center justify-between sticky top-0 z-10 shadow-md border-b border-stone-200">
                                <button onClick={() => setView('dashboard')} className="text-sm font-bold text-stone-500 hover:text-yellow-600 transition-colors">← Voltar</button>
                                <h1 className="font-bold text-yellow-600">Indicadores</h1>
                                <div className="w-10"></div>
                            </header>

                            <div className="flex border-b border-stone-200 bg-white p-2 gap-2 sticky top-[60px] z-10">
                                <button onClick={() => setAnalyticsTab('weekly')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${analyticsTab === 'weekly' ? 'bg-yellow-500 text-white' : 'bg-stone-100 text-stone-500 hover:bg-stone-200'}`}>Semanal</button>
                                <button onClick={() => setAnalyticsTab('monthly')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${analyticsTab === 'monthly' ? 'bg-yellow-500 text-white' : 'bg-stone-100 text-stone-500 hover:bg-stone-200'}`}>Mensal</button>
                            </div>

                            {analyticsTab === 'monthly' && (
                                <div className="px-6 pt-4">
                                    <label className="text-xs font-bold text-stone-500 uppercase flex items-center gap-2 mb-2"><Icons.Calendar /> Selecionar Mês</label>
                                    <input type="month" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="w-full p-2 bg-white border border-stone-300 rounded-lg text-stone-800 outline-none focus:border-yellow-500" />
                                </div>
                            )}

                            <main className="flex-1 p-6 pb-24 space-y-8">
                                <button onClick={() => setView('management_report')} className="w-full py-3 bg-yellow-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2 hover:bg-yellow-400 transition-all active:scale-95">
                                    <Icons.FileText /> Gerar Relatório Gerencial
                                </button>

                                <div className="bg-white rounded-xl p-6 border border-stone-200 text-center relative overflow-hidden shadow-sm">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-400"></div>
                                    <h3 className="text-xs font-bold text-stone-500 uppercase tracking-widest mb-2">{analyticsTab === 'weekly' ? 'Média Semanal' : 'Média Mensal'}</h3>
                                    <div className="flex justify-center items-end gap-2">
                                        <span className={`text-5xl font-black ${analytics.avgScore >= 85 ? 'text-green-600' : analytics.avgScore >= 60 ? 'text-yellow-600' : 'text-red-600'}`}>{analytics.avgScore}%</span>
                                    </div>
                                    <p className="text-[10px] text-stone-400 mt-2">Baseado em {analytics.ranking.length} registros</p>
                                </div>

                                <div>
                                    <h3 className="text-sm font-bold text-stone-700 mb-4 flex items-center gap-2"><Icons.Check /> Média por Auditor</h3>
                                    <div className="bg-white rounded-xl border border-stone-200 overflow-hidden shadow-sm">
                                        {analytics.auditorPerformance.length === 0 ? <div className="p-6 text-center text-stone-500 text-xs">Sem dados.</div> : (
                                            <table className="w-full text-left border-collapse">
                                                <thead>
                                                    <tr className="bg-stone-50 text-[10px] text-stone-500 uppercase border-b border-stone-200">
                                                        <th className="p-3">Auditor</th>
                                                        <th className="p-3 text-center">Qtd</th>
                                                        <th className="p-3 text-right">Nota Média</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-sm text-stone-700">
                                                    {analytics.auditorPerformance.map((aud, index) => (
                                                        <tr key={index} className="border-b border-stone-100 last:border-0 hover:bg-stone-50">
                                                            <td className="p-3 font-medium">{aud.name}</td>
                                                            <td className="p-3 text-center text-stone-500">{aud.count}</td>
                                                            <td className={`p-3 text-right font-bold ${aud.avg >= 85 ? 'text-green-600' : 'text-red-600'}`}>{aud.avg}%</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-sm font-bold text-stone-700 mb-4 flex items-center gap-2"><Icons.Chart /> Ranking {analyticsTab === 'weekly' ? 'Semanal' : 'Mensal'}</h3>
                                    <div className="bg-white rounded-xl border border-stone-200 overflow-hidden shadow-sm">
                                        {analytics.ranking.length === 0 ? <div className="p-6 text-center text-stone-500 text-xs">Sem dados.</div> : (
                                            <table className="w-full text-left border-collapse">
                                                <thead>
                                                    <tr className="bg-stone-50 text-[10px] text-stone-500 uppercase border-b border-stone-200">
                                                        <th className="p-3">#</th>
                                                        <th className="p-3">Setor</th>
                                                        <th className="p-3 text-right">Nota Média</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-sm text-stone-700">
                                                    {analytics.ranking.map((insp, index) => (
                                                        <tr key={insp.setor} className="border-b border-stone-100 last:border-0 hover:bg-stone-50">
                                                            <td className="p-3 font-mono text-stone-400">{index + 1}</td>
                                                            <td className="p-3 font-medium">{insp.setor}</td>
                                                            <td className={`p-3 text-right font-bold ${insp.score >= 85 ? 'text-green-600' : 'text-red-600'}`}>{insp.score}%</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                </div>

                                <div className="space-y-8">
                                    <div className="bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                                        <h3 className="text-xs font-bold text-stone-500 uppercase mb-4 text-center">Ocorrências (NC) por Setor</h3>
                                        <PieChart data={analytics.pieSector} />
                                    </div>

                                    <div className="bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                                        <h3 className="text-xs font-bold text-stone-500 uppercase mb-4 text-center">Ocorrências (NC) por Categoria</h3>
                                        <PieChart data={analytics.pieCategory} />
                                    </div>
                                </div>
                            </main>
                        </div>
                    )}

                    {/* VIEW: REPORT (PDF INDIVIDUAL) FALLBACK */}
                    {view === 'report' && !reportInspection && (
                        <div className="flex h-screen items-center justify-center bg-white">
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-yellow-500 mx-auto mb-4"></div>
                                <p className="text-gray-500">Gerando relatório...</p>
                                <button onClick={() => setView('dashboard')} className="mt-4 text-blue-500 underline text-sm">Voltar ao início</button>
                            </div>
                        </div>
                    )}

                    {/* VIEW: REPORT (PDF) */}
                    {view === 'report' && reportInspection && (
                        <div className="min-h-screen bg-white text-black p-8 max-w-4xl mx-auto print-container">
                            <div className="flex justify-between items-center mb-6 no-print">
                                <button onClick={() => setView('dashboard')} className="bg-stone-200 px-4 py-2 rounded font-bold">Voltar</button>
                                <button onClick={() => handleDownloadPDF('inspection-report-content', `Relatorio_${reportInspection.setor}_${reportInspection.data.split('T')[0]}.pdf`, false)} className="bg-yellow-500 text-white font-bold px-4 py-2 rounded flex items-center gap-2"><Icons.Download /> Baixar PDF</button>
                            </div>
                            <div id="inspection-report-content" className="border border-gray-300 p-8 print-border">
                                <div className="flex justify-between items-center border-b-2 border-black pb-4 mb-6">
                                    <div><h1 className="text-2xl font-bold uppercase">Relatório de Inspeção</h1><p className="text-sm text-gray-600">Gestão de Qualidade - IMAC</p></div>
                                    {logo && <img src={logo} className="h-12 object-contain print-img-small" />}
                                </div>
                                <div className="print-header-grid">
                                    <div><span className="font-bold block text-xs uppercase text-gray-500">Setor</span><span className="text-lg font-bold">{reportInspection.setor}</span></div>
                                    <div><span className="font-bold block text-xs uppercase text-gray-500">Data</span><span>{formatDateDisplay(reportInspection.data)}</span></div>
                                    <div><span className="font-bold block text-xs uppercase text-gray-500">Auditor</span><span>{reportInspection.responsavel}</span></div>
                                    <div>
                                        <span className="font-bold block text-xs uppercase text-gray-500">Nota (Gratificação)</span>
                                        <div className="flex items-center gap-1">
                                            <span className={(reportInspection.bonusScore !== undefined ? reportInspection.bonusScore : reportInspection.score) >= 85 ? 'text-green-700 font-black text-lg' : 'text-red-700 font-black text-lg'}>
                                                {reportInspection.bonusScore !== undefined ? reportInspection.bonusScore : reportInspection.score}%
                                            </span>
                                            <StarRating score={reportInspection.bonusScore !== undefined ? reportInspection.bonusScore : reportInspection.score} />
                                        </div>
                                    </div>
                                </div>
                                <div className="mb-8">
                                    <h3 className="font-bold border-b border-gray-300 mb-4 pb-1">Não Conformidades</h3>
                                    <div className="space-y-4 print-grid-2-cols">
                                        {Object.entries(reportInspection.respostas).filter(([_, v]) => v === 'NC').map(([qid, _]) => {
                                            const q = questions.find(qu => qu.id === qid);
                                            return (
                                                <div key={qid} className="print-nc-item border border-red-100 bg-red-50 p-3 rounded no-break">
                                                    <p className="font-bold text-sm text-red-700">{q?.pergunta}</p>
                                                    <p className="text-sm mt-1 text-gray-800"><span className="font-bold">Obs:</span> {reportInspection.observacoes[qid] || '-'}</p>
                                                    {reportInspection.evidencias && reportInspection.evidencias[qid] && (Array.isArray(reportInspection.evidencias[qid]) ? reportInspection.evidencias[qid] : [reportInspection.evidencias[qid]]).map((img, i) => (
                                                        <img key={i} src={img} className="mt-2 h-24 border bg-white object-contain print-img-evidence" />
                                                    ))}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    {Object.values(reportInspection.respostas).every(v => v !== 'NC') && <p className="italic text-gray-500">Nenhuma não conformidade.</p>}
                                </div>
                                <div className="mb-8 no-break">
                                    <h3 className="font-bold border-b border-gray-300 mb-4 pb-1">Plano de Ação Sugerido</h3>
                                    <div className="p-4 border rounded bg-gray-50 whitespace-pre-wrap text-sm">{actionPlan}</div>
                                </div>
                                <div className="mt-12 flex justify-between items-end no-break">
                                    <div className="text-center w-1/3"><p className="font-bold text-sm mb-8">{reportInspection.responsavel}</p><div className="border-t border-black pt-1 text-xs">Auditor</div></div>
                                    <div className="text-center w-1/3">{reportInspection.assinatura && <img src={reportInspection.assinatura} className="h-12 mx-auto mb-2 print-img-small" />}<div className="border-t border-black pt-1 text-xs">Responsável Setor</div></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* VIEW: MANAGEMENT REPORT */}
                    {view === 'management_report' && (
                        <div className="min-h-screen bg-white text-black p-8 max-w-4xl mx-auto print-container">
                            <div className="flex justify-between items-center mb-6 no-print">
                                <button onClick={() => setView('analytics')} className="bg-stone-200 text-stone-800 px-4 py-2 rounded font-bold border border-stone-300 hover:bg-stone-300">Voltar</button>
                                <div className="flex gap-2">
                                    <button onClick={() => handleDownloadPDF('management-report-content', `Relatorio_Semanal_${new Date().toISOString().split('T')[0]}.pdf`, false)} className="bg-blue-600 text-white font-bold px-4 py-2 rounded flex items-center gap-2 hover:bg-blue-700"><Icons.Download /> Baixar PDF</button>
                                </div>
                            </div>

                            <div id="management-report-content" className="bg-white p-8 border border-gray-300 shadow-sm print:shadow-none print:border-none print-scale-down">
                                <div className="flex justify-between items-center border-b-2 border-black pb-4 mb-8 print:mb-4 print:pb-2">
                                    <div><h1 className="text-3xl font-bold uppercase tracking-tight print:text-xl">Relatório Semanal</h1><p className="text-sm text-gray-500 uppercase tracking-widest mt-1 print:text-xs">Indicadores de Qualidade - IMAC</p></div>
                                    {logo && <img src={logo} className="h-16 object-contain print-img-small" />}
                                </div>

                                <div className="flex justify-between mb-8 text-sm bg-gray-50 p-4 rounded border border-gray-200 print:mb-4 print:p-2 print:text-xs">
                                    <div><strong>Período:</strong> {analyticsTab === 'weekly' ? 'Semanal (' + getWeekRangeFromDate(analyticsSelectedDate) + ')' : 'Mensal (' + selectedMonth + ')'}</div>
                                    <div><strong>Emissão:</strong> {new Date().toLocaleDateString()}</div>
                                </div>

                                <div className="mb-8 print:mb-4">
                                    <h2 className="text-lg font-bold border-b border-gray-300 mb-3 pb-1 uppercase text-gray-700 print:text-sm">1. Resumo Executivo</h2>
                                    <p className="text-justify leading-relaxed text-gray-800 print:text-xs">{analytics.summaryText}</p>
                                </div>

                                <div className="grid grid-cols-4 gap-4 mb-8 text-center print:mb-4 print:gap-2 print-grid-4">
                                    <div className="p-4 border rounded bg-gray-50 print:p-2">
                                        <div className="text-3xl font-black text-gray-800 print:text-xl">{analytics.avgScore}%</div>
                                        <div className="text-xs uppercase text-gray-500 font-bold mt-1 print:text-[10px]">Média Geral</div>
                                    </div>
                                    <div className="p-4 border rounded bg-yellow-50 border-yellow-200 print:p-2">
                                        <div className="text-3xl font-black text-yellow-800 print:text-xl">{analytics.avgBonusScore}%</div>
                                        <div className="text-xs uppercase text-yellow-800 font-bold mt-1 print:text-[10px]">Média Gratificação</div>
                                    </div>
                                    <div className="p-4 border rounded bg-gray-50 print:p-2">
                                        <div className="text-3xl font-black text-gray-800 print:text-xl">{analytics.ranking.length}</div>
                                        <div className="text-xs uppercase text-gray-500 font-bold mt-1 print:text-[10px]">Inspeções</div>
                                    </div>
                                    <div className="p-4 border rounded bg-gray-50 print:p-2">
                                        <div className="text-3xl font-black text-gray-800 print:text-xl">{analytics.pieCategory.length > 0 ? analytics.pieCategory[0].value : 0}</div>
                                        <div className="text-xs uppercase text-gray-500 font-bold mt-1 print:text-[10px]">Maior Incidência (NC)</div>
                                    </div>
                                </div>

                                {/* Ranking Geral em Tabela */}
                                <div className="mb-8 print:mb-4 no-break">
                                    <h2 className="text-lg font-bold border-b border-gray-300 mb-3 pb-1 uppercase text-gray-700 print:text-sm">2. Ranking Geral de Desempenho</h2>
                                    <div className="overflow-hidden border rounded-lg border-gray-200">
                                        <table className="w-full text-left border-collapse text-sm print:text-xs">
                                            <thead>
                                                <tr className="bg-gray-100 border-b border-gray-200 text-gray-600 uppercase text-[10px]">
                                                    <th className="p-3 font-bold text-center w-12">Pos.</th>
                                                    <th className="p-3 font-bold">Setor</th>
                                                    <th className="p-3 font-bold text-right">Nota (Gratificação)</th>
                                                    <th className="p-3 font-bold text-right">Classificação</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {analytics.ranking.map((r, i) => (
                                                    <tr key={i} className="hover:bg-gray-50">
                                                        <td className="p-3 text-center text-gray-400 font-mono font-bold">{i + 1}º</td>
                                                        <td className="p-3 font-bold text-gray-800">{r.setor}</td>
                                                        <td className={`p-3 text-right font-black ${r.score >= 85 ? 'text-green-700' : 'text-red-600'}`}>{r.score}%</td>
                                                        <td className="p-3">
                                                            <div className="flex justify-end"><StarRating score={r.score} /></div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="mb-8 print:mb-4 no-break">
                                    <h2 className="text-lg font-bold border-b border-gray-300 mb-4 pb-1 uppercase text-gray-700 print:text-sm">3. Análise de Ocorrências</h2>
                                    <div className="grid grid-cols-2 gap-8 print:gap-2 chart-container-print">
                                        <div className="chart-item-print">
                                            <h4 className="text-xs font-bold text-center mb-2 uppercase text-gray-500 w-full">Por Categoria</h4>
                                            <div className="flex justify-center w-full"><PieChart data={analytics.pieCategory} isReport={true} /></div>
                                        </div>
                                        <div className="chart-item-print">
                                            <h4 className="text-xs font-bold text-center mb-2 uppercase text-gray-500 w-full">Por Setor</h4>
                                            <div className="flex justify-center w-full"><PieChart data={analytics.pieSector} isReport={true} /></div>
                                        </div>
                                    </div>
                                </div>

                                {/* NOVA SEÇÃO: DETALHAMENTO DE PENDÊNCIAS (PLANO DE AÇÃO) */}
                                <div className="mb-8 print:mb-4 no-break">
                                    <h2 className="text-lg font-bold border-b border-gray-300 mb-3 pb-1 uppercase text-gray-700 print:text-sm">4. Detalhamento de Pendências e Prazos (Plano de Ação)</h2>
                                    
                                    {Object.keys(groupedIssues.pending).length === 0 ? (
                                        <p className="text-sm text-gray-500 italic p-4 border rounded bg-gray-50 text-center">Nenhuma pendência em aberto no momento.</p>
                                    ) : (
                                        <div className="space-y-4">
                                            {Object.entries(groupedIssues.pending).map(([setor, issues]) => (
                                                <div key={setor} className="border rounded-lg border-gray-200 overflow-hidden break-inside-avoid">
                                                    <div className="bg-gray-100 px-3 py-2 border-b border-gray-200 font-bold text-xs uppercase text-gray-700">
                                                        {setor}
                                                    </div>
                                                    <table className="w-full text-left border-collapse text-xs">
                                                        <thead>
                                                            <tr className="bg-gray-50 text-gray-500">
                                                                <th className="p-2 border-b border-gray-100 w-16">Data</th>
                                                                <th className="p-2 border-b border-gray-100 w-24">Categoria</th>
                                                                <th className="p-2 border-b border-gray-100">Ocorrência / NC</th>
                                                                <th className="p-2 border-b border-gray-100 w-20">Prazo</th>
                                                                <th className="p-2 border-b border-gray-100 w-20 text-center">Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {issues.map((issue, idx) => {
                                                                const today = new Date().toISOString().split('T')[0];
                                                                const isLate = issue.deadline && issue.deadline < today;
                                                                const q = questions.find(qu => qu.id === issue.questionId); // Buscar info da pergunta original
                                                                
                                                                return (
                                                                    <tr key={idx}>
                                                                        <td className="p-2 text-gray-600">{formatDateDisplay(issue.date.split('T')[0])}</td>
                                                                        <td className="p-2">
                                                                            <span className="text-[9px] font-bold bg-stone-100 text-stone-600 px-1.5 py-0.5 rounded border border-stone-200 uppercase">
                                                                                {q?.grupo || 'Geral'}
                                                                            </span>
                                                                        </td>
                                                                        <td className="p-2 font-medium text-gray-800">
                                                                            {issue.question}
                                                                            {issue.obs && <div className="text-[10px] text-gray-500 italic font-normal mt-0.5">Obs: {issue.obs}</div>}
                                                                        </td>
                                                                        <td className="p-2 text-gray-600 font-mono">{issue.deadline ? formatDateDisplay(issue.deadline) : '-'}</td>
                                                                        <td className="p-2 text-center">
                                                                            {isLate ? (
                                                                                <span className="text-[9px] font-bold bg-red-100 text-red-700 px-2 py-0.5 rounded border border-red-200">VENCIDO</span>
                                                                            ) : issue.deadline ? (
                                                                                <span className="text-[9px] font-bold bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-100">NO PRAZO</span>
                                                                            ) : (
                                                                                <span className="text-[9px] font-bold bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200">SEM DATA</span>
                                                                            )}
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="mb-8 print:mb-4 no-break">
                                    <h2 className="text-lg font-bold border-b border-gray-300 mb-3 pb-1 uppercase text-gray-700 print:text-sm">5. Observações Gerais (Supervisão)</h2>
                                    <textarea className="w-full h-40 p-4 border border-gray-300 rounded text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-black outline-none resize-none no-print" placeholder="Digite aqui as ações corretivas, prazos ou observações para a reunião..." value={actionPlan} onChange={e => setActionPlan(e.target.value)} />
                                    <div className="print-only whitespace-pre-wrap text-sm text-justify border border-gray-200 p-4 rounded min-h-[5rem] print:text-xs">{actionPlan || "Nenhuma observação adicional registrada."}</div>
                                </div>

                                <div className="mb-12 print:mb-4 no-break">
                                    <h2 className="text-lg font-bold border-b border-gray-300 mb-3 pb-1 uppercase text-gray-700 print:text-sm">6. Registro Fotográfico (Evidências de NC)</h2>
                                    <div className="print-grid-2-cols">
                                        {analytics.filteredInspections.map(insp => {
                                            const ncWithPhotos = Object.entries(insp.evidencias || {}).filter(([qId, photos]) => 
                                                insp.respostas[qId] === 'NC' && photos && (Array.isArray(photos) ? photos.length > 0 : photos)
                                            );

                                            if (ncWithPhotos.length === 0) return null;

                                            return (
                                                <div key={insp.id} className="print-nc-item mb-4 break-inside-avoid border-b border-gray-100 pb-2 print:border-none">
                                                    <h3 className="font-bold text-sm bg-gray-100 p-1 px-2 rounded border border-gray-200 flex justify-between items-center print:text-xs">
                                                        <span>{insp.setor}</span>
                                                        <span className="font-normal text-[10px] text-gray-500">{formatDateDisplay(insp.data)}</span>
                                                    </h3>
                                                    <div className="mt-1 space-y-2">
                                                        {ncWithPhotos.map(([qId, photos]) => {
                                                            const question = questions.find(q => q.id === qId);
                                                            const obs = insp.observacoes[qId];
                                                            const imgList = Array.isArray(photos) ? photos : [photos];
                                                            return (
                                                                <div key={qId} className="pl-2 border-l-2 border-red-300 mt-1">
                                                                    <p className="text-[10px] font-bold text-red-700 leading-tight">{question ? question.pergunta : 'Item removido'}</p>
                                                                    <p className="text-[10px] text-gray-600 mb-1 leading-tight"><span className="font-bold">Obs:</span> {obs || '-'}</p>
                                                                    <div className="flex gap-1 flex-wrap">
                                                                        {imgList.map((img, i) => (
                                                                            <img key={i} src={img} className="h-40 border border-gray-300 p-0.5 bg-white object-contain print-img-evidence" /> /* Increased size here */
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    {analytics.filteredInspections.every(insp => 
                                        Object.entries(insp.evidencias || {}).every(([qId, photos]) => 
                                            !(insp.respostas[qId] === 'NC' && photos && (Array.isArray(photos) ? photos.length > 0 : photos))
                                        )
                                    ) && <p className="text-sm italic text-gray-500 text-center py-4">Nenhuma evidência fotográfica registrada para Não Conformidades neste período.</p>}
                                </div>

                                <div className="mt-16 flex justify-end print:mt-4 no-break">
                                    <div className="text-center w-1/3"><div className="border-t border-black pt-2 font-bold text-sm print:text-xs">Supervisão da Qualidade</div><div className="text-xs text-gray-500">{new Date().toLocaleDateString()}</div></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL ASSINATURA */}
                    {isSigning && <SignaturePad onSave={handleSaveSignature} onCancel={() => setIsSigning(false)} initialData={signature} />}
                    {/* MODAL EDITAR PERGUNTA */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-fade-in">
                                <h2 className="text-lg font-bold mb-4 text-yellow-600">{editingQ ? 'Editar' : 'Nova'} Pergunta</h2>
                                <form onSubmit={handleSaveQuestion} className="space-y-4">
                                    <div><label className="block text-xs font-bold text-stone-500 uppercase mb-1">Setor</label><input name="setor" defaultValue={editingQ?.setor || ''} list="setores-list" className="w-full p-3 bg-stone-50 border rounded-lg outline-none focus:border-yellow-500" required placeholder="Ex: ESTOQUE" /><datalist id="setores-list">{allSetors.map(s => <option key={s} value={s} />)}</datalist></div>
                                    <div><label className="block text-xs font-bold text-stone-500 uppercase mb-1">Grupo</label><input name="grupo" defaultValue={editingQ?.grupo || ''} className="w-full p-3 bg-stone-50 border rounded-lg outline-none focus:border-yellow-500" required placeholder="Ex: LIMPEZA" /></div>
                                    <div><label className="block text-xs font-bold text-stone-500 uppercase mb-1">Pergunta</label><textarea name="pergunta" defaultValue={editingQ?.pergunta || ''} className="w-full p-3 bg-stone-50 border rounded-lg h-24 resize-none outline-none focus:border-yellow-500" required /></div>
                                    
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-stone-500 uppercase mb-1">Peso</label>
                                            <input type="number" name="weight" defaultValue={editingQ?.weight || 1} min="1" className="w-full p-3 bg-stone-50 border rounded-lg outline-none focus:border-yellow-500" />
                                        </div>
                                        <div className="flex items-center gap-2 pt-6">
                                            <input type="checkbox" name="critical" id="critical" defaultChecked={editingQ?.critical} className="w-5 h-5 text-yellow-600 rounded" />
                                            <label htmlFor="critical" className="text-sm font-bold text-stone-700">Marcar como Crítica (Visual)</label>
                                        </div>
                                    </div>

                                    <div className="flex gap-2 pt-2"><button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-3 border rounded-lg font-bold">Cancelar</button><button type="submit" className="flex-1 py-3 bg-yellow-500 text-white rounded-lg font-bold">Salvar</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function App() {
            return (
                <ToastProvider>
                    <AppContent />
                </ToastProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
